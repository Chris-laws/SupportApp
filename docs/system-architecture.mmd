flowchart TD
    subgraph UserFacing["Nutzeroberfläche"]
        Browser["Browser + Tailwind UI<br/>index.html"]
    end

    subgraph WebApp["FastAPI Webserver (webserver.py)"]
        AskRoot["/ (index.html)"]
        AskHTML["/ask-html<br/>Form/Sync"]
        AskJSON["/ask<br/>JSON API"]
        Result["/result/{job_id}"]
        ContextPrep["prepare_context"]
        Prompt["build_prompt"]
        JobStore["Jobs In-Memory"]
    end

    subgraph Retrieval["Retriever (modules/retriever.py)"]
        Rewrite["rewrite_query_with_llama3<br/>(Ollama)"]
        Embed["SentenceTransformer<br/>get_embeddings"]
        Hybrid["HybridRetriever.retrieve"]
        ContextSel["select_context_window"]
    end

    subgraph Knowledge["Wissensbasis"]
        FAISS["FAISS Index + Embeddings"]
        Chunks["Chunk Records<br/>(PDF, Heading, Metadata)"]
    end

    subgraph LLM["LLM-Dienste"]
        OllamaQuery["query_ollama<br/>(Antwort)"]
        OllamaRewrite["Ollama Llama3<br/>(Query Rewrite)"]
    end

    subgraph Ingestion["Offline-Aufbereitung"]
        PDFs["Quell-PDFs"]
        Chunker["load_and_chunk_pdf"]
        EmbedBuild["save_embeddings_to_faiss"]
    end

    Browser --> AskRoot
    AskRoot --> Browser
    Browser --> AskHTML
    Browser --> AskJSON
    AskHTML -->|Job-ID| JobStore
    AskJSON --> ContextPrep
    AskHTML --> ContextPrep
    ContextPrep --> Rewrite
    Rewrite --> OllamaRewrite
    OllamaRewrite --> Rewrite
    ContextPrep --> Embed
    Embed --> Hybrid
    Hybrid --> FAISS
    Hybrid --> Chunks
    Hybrid --> ContextSel
    ContextSel --> Prompt
    Prompt --> OllamaQuery
    OllamaQuery --> AskJSON
    OllamaQuery --> AskHTML
    AskJSON --> Browser
    AskHTML --> Browser
    JobStore --> Result
    Result --> Browser
    PDFs --> Chunker
    Chunker --> Chunks
    Chunker --> EmbedBuild
    EmbedBuild --> FAISS
    EmbedBuild --> Chunks
