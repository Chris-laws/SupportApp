flowchart LR
  %% Schichten
  subgraph UI[Praesentationsschicht]
    UI1["Chat-UI"]
  end

  subgraph SERVICE[Service-Schicht]
    S1["Request Handling"]
    S2["Orchestrierung"]
    S3["Formatierung & Quellenaggreg."]
  end

  subgraph RETRIEVAL[Retrieval-Schicht]
    R1["Lexikalische Suche<br/>(z. B. BM25)"]
    R2["Semantische Suche<br/>(Embeddings)"]
    R3[("Re-Ranking, optional")]
  end

  subgraph GENERATION[Generierungs-Schicht]
    G1["LLM-Inferenz<br/>(lokal)"]
  end

  subgraph DATA[Datenschicht]
    D1[("Dokumentenablage")]
    D2[("Vektorindex")]
    D3[("Metadaten/Logs")]
    D4[("Termindex")]
  end

  %% Kanten (konzeptionell)
  UI1 -- REST/JSON --> S1
  S1 --> S2
  S2 --> R1
  S2 --> R2
  R1 --> S2
  R2 --> S2
  S2 --> R3
  R3 --> S2
  S2 --> G1
  G1 --> S3
  S3 -- REST/JSON --> UI1

  %% Datenzugriffe
  R1 --- D4
  R2 --- D2
  S2 --- D3
  R1 --- D1
  R2 --- D1

  %% Hinweise
  classDef note fill:#f6f6f6,stroke:#aaa,color:#333,stroke-dasharray: 3 3
  N1["Kontextfensterbildung<br/>(Quellenvielfalt, Laenge, Keywords)"]:::note
  S2 --- N1
